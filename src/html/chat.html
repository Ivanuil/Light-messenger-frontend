<html>
<head>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        axios.defaults.withCredentials = true;

        function sendHttp() {
            const to = document.getElementById("username").value;
            const text = document.getElementById("message").value;

            const requestBody = {
                to,
                text
            }
            axios.post('http://127.0.0.1:8080/send', requestBody)
                .then((response) => {
                    if (response.status === 200)
                        document.getElementById("status").textContent="Success";
                    else
                        document.getElementById("status").textContent="Fail (status: " + response.status + ")";
                })
                .catch((error) => {
                    document.getElementById("status").textContent="Fail (" + error.toString() + ")";
                });
        }

        let socket = new WebSocket("ws://127.0.0.1:8080/websocket");
        socket.onmessage = (event) => {
            const messageBlock = document.createElement("p");

            try {
                const messageObj = JSON.parse(event.data);

                const authorBlock = document.createElement("b");
                authorBlock.textContent += messageObj.from;
                messageBlock.appendChild(authorBlock);
                messageBlock.appendChild(document.createElement("br"))

                const textBlock = document.createTextNode(messageObj.text);
                messageBlock.appendChild(textBlock);
            } catch (e) {
                messageBlock.textContent += event.data;
            }

            document.getElementById("chat").appendChild(messageBlock);
        }
        socket.onopen = () => {
            console.log("Opened socket");
        }
        socket.onclose = () => {
            console.log("Closed socket, attempting to reopen");
            socket = new WebSocket("ws://127.0.0.1:8080/websocket");
        }

        function sendSocket() {
            const to = document.getElementById('to_socket').value;
            const text = document.getElementById('messageEdit').value;
            const requestBody = {
                to,
                text
            }
            socket.send(JSON.stringify(requestBody));
            document.getElementById("to_socket").value = "";
            document.getElementById("messageEdit").value = "";
        }
    </script>
</head>
<body>
    <h1>Send message as HTTP:</h1>
    <form>
        <label for="username">Recipient username:</label>
        <input type="text" name="username" id="username"/>
        <br>
        <label for="message">Message:</label>
        <input type="text" name="message" id="message"/>
        <br>
        <input type="button" value="Send" id="submit" onclick="sendHttp()"/>
        <p id="status"></p>
    </form>

    <h1>Chat through WebSocket:</h1>
    <div id="chat" style="overflow: auto; height: 200px"></div>
    <br>
    <form>
        <label for="to_socket">To: </label>
        <input type="text" name="to_socket" id="to_socket"/>
        <br>
        <label for="messageEdit">Message:</label>
        <input type="text" name="messageEdit" id="messageEdit"/>
        <input type="button" value="Send" id="send" onclick="sendSocket()">
    </form>
</body>
</html>